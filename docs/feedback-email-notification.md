# 📧 관리자 피드백 이메일 알림 기능

## 🎯 개요
사용자가 피드백을 제출하면 자동으로 모든 관리자에게 이메일 알림을 발송하는 기능입니다.

## 🛠 기술 스택
- **이메일 서비스**: Resend API
- **템플릿**: HTML 문자열 (반응형 디자인)
- **인증**: Clerk (관리자 조회용)
- **데이터베이스**: Supabase (관리자 역할 확인)

## 📋 구현 구조

### 1. 주요 파일
```
lib/email.ts                    # 이메일 발송 로직
app/api/feedback/route.ts       # 피드백 API (이메일 알림 통합)
.env.local                      # 환경변수 설정
```

### 2. 함수 구조
```typescript
// 관리자 이메일 조회
getAdminEmails(): Promise<string[]>

// 이메일 HTML 템플릿 생성
generateFeedbackEmailHTML(feedback: FeedbackData): string

// 이메일 발송
sendFeedbackNotificationEmail(feedback: FeedbackData): Promise<void>
```

## 🔧 환경변수 설정
```bash
# .env.local
RESEND_API_KEY=re_5HAc7uQy_26fiqurXy8vo3rKoT43rFeCc
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

## 🎨 이메일 템플릿 구성

### 헤더
- LunchLab 로고 및 브랜드명
- 파란색 배경으로 시각적 임팩트

### 주요 내용
- 제출자 정보 (이메일 또는 익명)
- 제출 시간 (한국 시간 기준)
- 피드백 내용 (200자 이상시 말줄임)

### 액션 버튼
- **피드백 상세보기**: 해당 피드백 상세 페이지 직접 이동
- **피드백 관리 페이지**: 전체 피드백 목록 페이지 이동

## 🔄 동작 프로세스

### 1. 피드백 제출 시
```typescript
1. 사용자가 피드백 제출
2. Supabase에 피드백 저장
3. 저장 성공 시 백그라운드에서 이메일 발송
4. 사용자에게 성공 응답 반환 (이메일 실패와 무관)
```

### 2. 관리자 조회 과정
```typescript
1. company_memberships 테이블에서 role='admin' 조회
2. Clerk API로 해당 사용자들의 이메일 주소 조회
3. 유효한 이메일만 필터링하여 반환
```

### 3. 이메일 발송 과정
```typescript
1. 각 관리자에게 개별적으로 이메일 발송
2. 성공/실패 결과 로깅
3. 일부 실패해도 전체 프로세스 중단하지 않음
```

## ⚡ 에러 처리 전략

### 1. 피드백 저장 우선
- 이메일 발송 실패해도 피드백 저장은 성공
- 사용자에게는 항상 성공 응답 반환

### 2. 백그라운드 처리
- 이메일 발송을 비동기로 처리
- 사용자 응답 시간에 영향 없음

### 3. 로깅 시스템
```typescript
// 성공 로그
console.log('피드백 알림 이메일 발송 성공 - user@example.com: msg_id')

// 실패 로그
console.error('피드백 알림 이메일 발송 실패 - user@example.com:', error)
```

## 🧪 테스트 방법

### 1. 수동 테스트
```bash
# 개발 서버 시작
npm run dev

# 피드백 제출 후 콘솔 로그 확인
```

### 2. 단위 테스트
```bash
# 이메일 발송 테스트
node __tests__/email-test.js
```

## 📱 이메일 디자인 특징

### 반응형 디자인
- 모바일 기기에서도 최적화된 레이아웃
- 600px 최대 너비로 가독성 확보

### 브랜드 아이덴티티
- LunchLab 브랜드 컬러 (#3b82f6) 사용
- 일관된 타이포그래피와 스페이싱

### 사용성
- 명확한 액션 버튼
- 피드백 내용 미리보기
- 직관적인 정보 구조

## 🔮 향후 개선 방향

### 1. 알림 설정
- 관리자별 이메일 알림 on/off 설정
- 알림 빈도 조절 (즉시/일일요약/주간요약)

### 2. 다양한 알림 채널
- Slack 연동
- Discord 웹훅
- SMS 알림

### 3. 분석 기능
- 이메일 열람율 추적
- 피드백 응답 시간 분석
- 관리자별 활동 통계

## 🚨 주의사항

### 1. API 키 보안
- RESEND_API_KEY는 서버 환경변수로만 사용
- 클라이언트에 노출되지 않도록 주의

### 2. 이메일 발송 제한
- Resend 무료 플랜: 월 3,000통 제한
- 대량 발송 시 유료 플랜 고려

### 3. 도메인 인증
- 프로덕션 환경에서는 자체 도메인 사용 권장
- onboarding@resend.dev는 테스트 전용

## 📞 트러블슈팅

### 이메일이 발송되지 않는 경우
1. RESEND_API_KEY 환경변수 확인
2. 관리자가 등록되어 있는지 확인
3. 콘솔 로그에서 오류 메시지 확인

### 이메일이 스팸함에 들어가는 경우
1. 발송자 도메인 SPF/DKIM 설정
2. 이메일 내용의 스팸 키워드 확인
3. 수신자의 이메일 필터 설정 확인 